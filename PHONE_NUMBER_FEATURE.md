# 📞 電話番号機能追加ガイド

## 🎯 追加された機能

### 1. 電話番号入力フィールド
- ✅ 応募フォームに電話番号入力欄を追加
- ✅ ハイフンあり・なしどちらでも入力可能
- ✅ 必須項目として設定

### 2. 電話番号のハッシュ化（SHA-256）
- ✅ 入力された電話番号をSHA-256でハッシュ化
- ✅ 元の電話番号は保存されない（プライバシー保護）
- ✅ ハッシュ値のみをFirestoreに保存

### 3. 重複応募チェック
- ✅ 同じ電話番号での複数応募を防止
- ✅ Googleアカウントが異なっても、電話番号が同じなら重複と判定
- ✅ 重複検出時にエラーメッセージを表示

### 4. 当選者への案内
- ✅ 「送付先住所は当選後に改めて伺う」旨を明記
- ✅ 現時点では電話番号のみで応募可能

---

## 🔐 セキュリティとプライバシー

### 電話番号の保護

**保存されるデータ:**
```javascript
{
  uid: "ユーザーID",
  name: "山田太郎",
  email: "yamada@example.com",
  phoneHash: "a1b2c3d4...", // ← ハッシュ化された電話番号（64文字）
  appliedAt: Timestamp,
  status: "pending"
}
```

**保存されないデータ:**
- ❌ 元の電話番号（090-1234-5678など）

### ハッシュ化の仕組み

1. **正規化**: `090-1234-5678` → `09012345678`（ハイフン削除）
2. **ハッシュ化**: `09012345678` → `a1b2c3d4e5f6...`（SHA-256）
3. **保存**: ハッシュ値のみをFirestoreに保存

### メリット

- ✅ **プライバシー保護**: 元の電話番号は復元不可能
- ✅ **重複チェック可能**: 同じ電話番号は同じハッシュ値になる
- ✅ **データ漏洩対策**: 万が一データが漏洩しても電話番号は分からない

---

## 📋 Firestoreセキュリティルールの更新

### 新しいルール

```javascript
allow create: if request.auth != null 
              && request.auth.uid == uid
              && request.resource.data.keys().hasAll(['uid', 'name', 'email', 'phoneHash', 'appliedAt', 'status'])
              && request.resource.data.uid == uid
              && request.resource.data.status == 'pending'
              && request.resource.data.phoneHash is string
              && request.resource.data.phoneHash.size() == 64;  // SHA-256ハッシュは64文字
```

### 検証内容

- ✅ 必須フィールドに `phoneHash` を追加
- ✅ `phoneHash` が文字列であることを確認
- ✅ `phoneHash` が64文字（SHA-256の長さ）であることを確認

---

## 🚀 デプロイ手順

### 1. Firestoreセキュリティルールの更新

1. Firebase Console → Firestore Database → ルール
2. `firestore.rules` の内容をコピー＆ペースト
3. 「公開」をクリック

### 2. ファイルをGitHubにアップロード

```powershell
# 変更されたファイル:
# - index.html (電話番号入力フィールド追加)
# - styles.css (入力フィールドのスタイル追加)
# - app.js (ハッシュ化・重複チェック機能追加)
# - firestore.rules (セキュリティルール更新)
```

### 3. GitHub Pagesの更新を待つ

アップロード後、1〜5分で反映されます。

---

## 🧪 テスト手順

### テスト1: 正常な応募

1. サイトにアクセス
2. Googleログイン
3. 電話番号を入力（例: `090-1234-5678`）
4. 「応募する」をクリック
5. ✅ 応募完了画面が表示される

### テスト2: 電話番号未入力

1. 電話番号を空欄のまま「応募する」をクリック
2. ✅ 「電話番号を入力してください。」エラーが表示される

### テスト3: 不正な電話番号

1. 電話番号に `123` など不正な値を入力
2. 「応募する」をクリック
3. ✅ 「正しい電話番号を入力してください。」エラーが表示される

### テスト4: 重複応募（同じ電話番号）

1. 一度応募を完了
2. ログアウト
3. 別のGoogleアカウントでログイン
4. **同じ電話番号**を入力
5. 「応募する」をクリック
6. ✅ 「この電話番号は既に応募済みです。」エラーが表示される

### テスト5: 重複応募（同じGoogleアカウント）

1. 一度応募を完了
2. ログアウト
3. 同じGoogleアカウントでログイン
4. ✅ 「応募済みです」画面が表示される

---

## 📊 管理者用スクリプトの更新

### エクスポートされるデータ

```json
{
  "uid": "abc123...",
  "name": "山田太郎",
  "email": "yamada@example.com",
  "phoneHash": "a1b2c3d4e5f6...",
  "appliedAt": "2026-02-12T10:00:00.000Z",
  "status": "pending"
}
```

### 注意事項

⚠️ **電話番号の元の値は取得できません**

- ハッシュ化された値のみが保存されているため、元の電話番号は復元不可能です
- 当選者には**メールで改めて送付先情報を伺う**必要があります

---

## 💡 よくある質問

### Q1: 電話番号を変更したい場合は？

**A:** 応募後の変更はできません。新しい電話番号で再応募する場合は、別のGoogleアカウントが必要です。

### Q2: 電話番号のハッシュ値から元の番号は分かりますか？

**A:** いいえ、SHA-256ハッシュは一方向関数なので、ハッシュ値から元の電話番号を復元することは不可能です。

### Q3: 当選者の連絡先はどうやって取得しますか？

**A:** 当選者には登録されたメールアドレス宛に連絡し、改めて送付先住所などを伺います。

### Q4: 固定電話でも応募できますか？

**A:** はい、10桁または11桁の日本の電話番号であれば、固定電話でも応募可能です。

---

## 🔒 セキュリティチェックリスト

- [ ] Firestoreセキュリティルールが更新されている
- [ ] `phoneHash` フィールドの検証が含まれている
- [ ] 重複チェック機能が動作している
- [ ] 電話番号のバリデーションが動作している
- [ ] 元の電話番号がFirestoreに保存されていないことを確認

---

**最終更新**: 2026年2月12日  
**バージョン**: 2.0.0（電話番号機能追加版）
