rules_version = '2';

// ==========================================
// Firestore セキュリティルール（企画管理対応版）
// ==========================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 管理者判定関数
    function isAdmin() {
      // ここに管理者のメールアドレスを追加
      return request.auth != null && 
             request.auth.token.email in [
               'daisukevladkensyu@gmail.com'  // 管理者のメールアドレス
             ];
    }
    
    // campaignsコレクション（企画情報）
    match /campaigns/{campaignId} {
      // 読み取り: 誰でも可能（企画情報は公開）
      allow read: if true;
      
      // 作成・更新・削除: 管理者のみ
      allow create, update, delete: if isAdmin();
    }
    
    // applicantsコレクション（応募者情報）
    match /applicants/{applicantId} {
      // applicantIdの形式: {campaignId}_{uid}
      
      // 作成: 認証済みユーザーが自分のデータを作成する場合のみ
      allow create: if request.auth != null 
                    && applicantId == request.resource.data.campaignId + '_' + request.auth.uid
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.keys().hasAll(['campaignId', 'uid', 'phoneHash', 'appliedAt', 'status'])
                    && request.resource.data.status == 'pending'
                    && request.resource.data.phoneHash is string
                    && request.resource.data.phoneHash.size() == 64
                    && !request.resource.data.keys().hasAny(['name', 'email', 'phone']);
      
      // 読み取り: 本人または管理者のみ
      allow read: if request.auth != null && 
                     (applicantId.matches('.*_' + request.auth.uid) || isAdmin());
      
      // 更新・削除: 管理者のみ
      allow update, delete: if isAdmin();
    }
    
    // その他のコレクションはすべて拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
